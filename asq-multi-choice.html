<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../asq-option/asq-option.html">
<link rel="import" href="../asq-base/asq-base.html">

<!-- TODO ? : add selection for asq-multi-choice -->
<!--
`asq-multi-choice` is multi-choice question used in ASQ. It can be not only 'multi-choices' but also 'single-choice' by setting the attribute `choose` '1' or 'n'.

##### Example
    <asq-multi-choice choose="n">
      <asq-stem><h3>An asq-multi-choice question.</h3></asq-stem>
      <asq-option name="option-1">Option 1</asq-option>
      <asq-option name="option-2">Option 2</asq-option>
      <asq-option name="option-3">Option 3</asq-option>
      <asq-option name="option-4">Option 4</asq-option>
    </asq-multi-choice>

In the example above, you can choose any number of answers because the value of `choose` is n.

@element asq-multi-choice
@group ASQ Elements
@blurb Element acting as options in multichoice questions.
@homepage http://github.com/ASQ_USI/asq-multi-choice
-->
<polymer-element name="asq-multi-choice" attributes="choose">
  <template>
    <style>
      content[select="asq-option"]::content asq-option{
        display:block;
        margin-bottom: 1em;
        padding:0;
      }
    </style>

    <!-- (for now) Keep same when either viewer or presenter -->
    <div class="asq-multi-choice">
      <content select="asq-stem"></content>
      <div id="choices">
        <ol>
        <!-- if choose == 1 we need a paper-radio-group element to group 
        paper-radio-buttons  -->
        <template if="{{choose=='1'}}">
          <paper-radio-group>
            <content select="asq-option"></content>
          </paper-radio-group>
        </template>
        <template if="{{choose!='1'}}">
            <content select="asq-option"></content>
        </template>
        </ol>
      </div>
    </div>
    
  </template>

  <script>
  (function() {
    var p = {

      /**
       * This attribute indicates whether this `asq-multi-choice` question is `multi-choices` or `single-choice`.
       *
       * @attribute type
       * @type string
       * @default 'n'
       */
      choose: "n",

      ready: function(){
        //make asq-option elements checkboxes or radio buttons
        var inputType = (this.choose == '1')
          ? 'radio'
          : 'checkbox';

        var aos = this.querySelectorAll('asq-option');
        aos = Array.prototype.slice.call(aos);
        aos.forEach(function(ao){
          ao.type = inputType;
        });

        role = this.roles.VIEWER;
      },

      created: function(){
        document.addEventListener('asq-ready', function(evt){
          try{
            this.subscribeToEvents(evt.detail.asqEventBus)
          }catch(err){
            console.debug('failed to subscribeToEvents');
          }
        }.bind(this));
      },

      onQuestionType: function(evt){
        if(evt && evt.questionType && evt.questionType == 'asq-multi-choice'){
          if(evt.type == "progress"){
            this.onProgress(evt)
          }
        }
      },

      onProgress: function(evt){
        if(evt.questionUid !== this.uid) return;
        if(this.role !== this.roles.PRESENTER) return;
        this.updateProgress(evt.options, evt.total)
      },

      updateProgress: function(options, total){
        total = total | 100;
        for (var key in options){
          if(options.hasOwnProperty(key)){
            this.updateOptionProgress(key, options[key], total);
          }
        }
      },

      updateOptionProgress: function(uid, val, total){
        var option = document.querySelector('asq-option[uid="'+ uid +'"]');
        if(! option){
          console.log('failed to updateOptionProgress, could not find option with uid %s', uid);
          return;
        }
        var progressBar = option.shadowRoot.getElementById('progressBar');
        progressBar.max = parseInt(total);
        progressBar.value = parseInt(val);
      },

      subscribeToEvents: function(eventBus){
        eventBus.on('asq:question_type', this.onQuestionType.bind(this))
      },

      /**
         * The `submit` method will submit the answer to a wrapped 'asq-exercise' instance. 
         * Only useful when the `role` is `viewer`.
         *
         * @method submit
         */
      submit: function() {
        if ( this.role !== this.roles.VIEWER ) {
          return;
        }

        var options = this.childNodes.array().filter(function(el) {
          return el.isASQElement && el.nodeName == "ASQ-OPTION";
        });

        var submission = [];
        options.forEach(function(elem, index) {
          submission.push(elem.submit());
        });   

        return {
          questionUid: this.uid,
          timestamp: new Date(),
          submission: submission
        };
      }

    }

    ASQ.asqify(p, true);
    Polymer('asq-multi-choice', p);

  })();
  </script>
</polymer-element>
